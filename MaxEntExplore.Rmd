---
title: "ExploreData"
author: "John Phelan and Chris Madsen"
date: "8/28/2024"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.width = 12, fig.height = 8)
library(tidyverse)
library(DBI)
library(bcinvadeR)
library(terra)
library(sf)
library(geodata)
library(predicts)
library(ggpubr)
library(dismo)
library(rJava)
library(spatstat)
library(ape)
source("ZuurFuncs.R")
source("scripts/utils/thin_occ.R")

#set locations
proj_wd = getwd()
onedrive_wd = paste0(str_extract(getwd(),"C:/Users/[A-Z]+/"),"OneDrive - Government of BC/data/CNF/")

```

## Data description

The modelling efforts are to describe the highest risk locations for aquatic invasive species (AIS), by species and by identifying suitable habitat per species, a general map of potential suitable habitat for AIS. To do this, presence data is supplied to a model with a list of potential explanatory variables.

Presence data comes from a range of sources:

1.	Wildlife Species Inventory Incidental Observations layer on BC Warehouse

2.	Aquatic Invasive Species of British Columbia layer on BC Warehouse

3.	Master Incidence Report Records excel file

4.	iNaturalist (BC only)

These sources provide us with the source of the data, The date of recording, the species in question, the name of the location, and the geometry (location) where the species was recorded. There are no absence data supplied.

For explanatory variables, there are a number of data available. The bioclim model gives a range of climatic variable that can be included. Such as temperature and precipitation. This is a raster file. The bioclim data is available both for present day and future climate scenarios. There are also a range of resolutions for the data. Resolutions may need to be altered for modelling.

Annual mean temperature is available from Worldclim. Historical and future climate scenarios are available. The data are supplied as rasters and are in 2.5, 5 or 10 minute increments. Water chemistry and temperature data are available from other sources, such as the environmental monitoring dataset. 

pH and Calcium data are available from Geurin et al. 2024 where they used water quality data to interpolate values for these variables for North America in a 10*10km grid. Data are supplied as rasters.


Temperature should come from EMS too!


```{r data_collection, echo=FALSE}
sppOI<-"goldfish"
# Get occurrence data for species (if we haven't done this yet!)
if(!exists("d")){
  d = suppressMessages(grab_aq_occ_data(sppOI))
}

d_thin<-thin_occ(d)
# Pull in climate variables
ph_NAM = terra::rast(paste0(onedrive_wd,"ph-KR-208784-median_10km_ZN.tif")) |> terra::project("EPSG:4326")
names(ph_NAM) <- "pH"
Calc_NAM = terra::rast(paste0(onedrive_wd,"calcium-KR-97648-median-10km-ZN.tif")) |> terra::project("EPSG:4326")
names(Calc_NAM) <- "calc"

# Read in variable names for the worldclim variables.
source(paste0(proj_wd,"/scripts/utils/worldclim_bioc_var_names.R"))
cmidata<-cmip6_world("ACCESS-CM2", ssp = "585", var = "bioc", res = 5, time = "2021-2040",path="CMI/")
names(cmidata)<-renames
pred_bioc = terra::rast("CMI/climate/wc2.1_5m/wc2.1_5m_bioc_ACCESS-CM2_ssp585_2021-2040.tif")
names(pred_bioc)<-renames

# Cut our rasters down to just BC.
bc_vect = terra::vect(sf::st_transform(bcmaps::bc_bound(),4326))
ph_clipped = mask(crop(ph_NAM, bc_vect), bc_vect)
calc_clipped = mask(crop(Calc_NAM, bc_vect), bc_vect)
pred_bioc_clipped = mask(crop(pred_bioc, bc_vect), bc_vect)

# Pull in elevation raster with {elevatr}
elev = suppressMessages(elevatr::get_elev_raster(locations = sf::st_as_sf(bc_vect), z = 4)) |>
  terra::rast() |> 
  terra::crop(bc_vect) |> 
  terra::mask(bc_vect)
names(elev) = "elev"

```




```{r fixing_data}
NA_ph_res = terra::resample(ph_clipped, pred_bioc_clipped)
NA_calc_res = terra::resample(calc_clipped, pred_bioc_clipped)

elev_res = terra::resample(elev, pred_bioc_clipped)

all_rasters = c(pred_bioc_clipped, NA_ph_res, NA_calc_res, elev_res)

names(all_rasters)[c(1,12)] <- c("temp","precip")
temps<-pred_bioc_clipped[[1]]
precip<-pred_bioc_clipped[[12]]

stack_data<-c(NA_ph_res, NA_calc_res, elev_res, temps, precip)
names(stack_data)<-c("pH", "calc", "elev", "temp", "precip")

# Trim away bits outside of watercourses.
watercourses = terra::rast(paste0(onedrive_wd,"stream_density_6_plus_order_raster.tif")) |> 
  terra::project("EPSG:4326") |> 
  terra::resample(pred_bioc_clipped) |> 
  terra::mask(bc_vect)


samp<- d %>% 
    plyr::mutate(x = st_coordinates(geometry)[,1],
                     y = st_coordinates(geometry)[,2]) %>% 
    sf::st_drop_geometry() |> 
    dplyr::select(x,y) |> 
    mutate(present = 1)



samp_thin<-d_thin %>% 
  plyr::mutate(x = st_coordinates(geometry)[,1],
                     y = st_coordinates(geometry)[,2]) %>% 
    sf::st_drop_geometry() |> 
    dplyr::select(x,y) |> 
    mutate(present = 1)

```

```{r get_var_at_spp_occurance}
# Extract raster variable values at species occurrence point locations.
samp$temp = terra::extract(pred_bioc_clipped[[1]], samp[,c("x","y")], ID = FALSE)
samp$precip = terra::extract(pred_bioc_clipped$Annual_Precipitation, samp[,c("x","y")], ID = FALSE)
samp$calc = terra::extract(calc_clipped$calc, samp[,c("x","y")], ID = FALSE)
samp$pH = terra::extract(ph_clipped, samp[,c("x","y")], ID = FALSE)
samp$elev = terra::extract(elev, samp[,c("x","y")], ID = FALSE)
samp = as.data.frame(samp)

samp = samp |> 
  mutate(across(everything(), \(x) as.numeric(unlist(x))))
#dop NA's
samp = samp[complete.cases(samp),]


samp_thin$temp = terra::extract(pred_bioc_clipped[[1]], samp_thin[,c("x","y")], ID = FALSE)
samp_thin$precip = terra::extract(pred_bioc_clipped$Annual_Precipitation, samp_thin[,c("x","y")], ID = FALSE)
samp_thin$calc = terra::extract(calc_clipped$calc, samp_thin[,c("x","y")], ID = FALSE)
samp_thin$pH = terra::extract(ph_clipped, samp_thin[,c("x","y")], ID = FALSE)
samp_thin$elev = terra::extract(elev, samp_thin[,c("x","y")], ID = FALSE)
samp_thin = as.data.frame(samp_thin)

samp_thin = samp_thin |> 
  mutate(across(everything(), \(x) as.numeric(unlist(x))))
#dop NA's
samp_thin = samp_thin[complete.cases(samp_thin),]




```

### Where are the observations?

#### Presence plot
```{r plot_points}

bc<-sf::st_transform(bcmaps::bc_bound(),4326)

ggplot()+
  geom_sf(data = bc, color = "lightgrey", alpha = 0.7)+
  geom_point(data = samp, aes (x = x, y = y, color = as.factor(present)), size = 1.3)+
  scale_color_manual(values = c("0" = "purple", "1" = "darkgreen"),
                     labels = c("0" = "Absent", "1" = "Present"))+
  labs(color = paste0("Presence of ",sppOI))+
  ggthemes::theme_map()+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        legend.position = 'bottom',
        panel.background = element_blank()
  ) 
  

```

Goldfish are found in multiple locations across the province, with a concentration in the south west of the province. This could be due to a sampling error, but it more likely due to their method of introduction to British Columbia. Release of goldfish is done by people who had them as pets.

### Variables {.tabset}

#### Outliers {.tabset}

##### Temperature
```{r temp_plots}

ggplot()+
geom_boxplot(data = samp, aes(y = temp))+
  labs(title = "Temperature")+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        legend.position = 'bottom',
        panel.background = element_blank()
        )

ggplot()+
geom_boxplot(data = samp_thin, aes(y = temp))+
  labs(title = "Temperature thinned")+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        legend.position = 'bottom',
        panel.background = element_blank()
        )

```

##### Precipitation plots
```{r precip_plot}
ggplot()+
geom_boxplot(data = samp, aes(y = precip))+
  labs(title = "Precipitation")+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        legend.position = 'bottom',
        panel.background = element_blank()
        )
ggplot()+
geom_boxplot(data = samp_thin, aes(y = precip))+
  labs(title = "Precipitation thinned")+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        legend.position = 'bottom',
        panel.background = element_blank()
        )
```

##### Calcium plots
```{r Ca_plot}
ggplot()+
geom_boxplot(data = samp, aes(y = calc))+
  labs(title = "Calcium")+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        legend.position = 'bottom',
        panel.background = element_blank()
        )

ggplot()+
geom_boxplot(data = samp_thin, aes(y = calc))+
  labs(title = "Calcium thinned")+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        legend.position = 'bottom',
        panel.background = element_blank()
        )
```

##### ph plots
```{r pH_plot}
ggplot()+
geom_boxplot(data = samp, aes(y = pH))+
  labs(title = "pH")+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        legend.position = 'bottom',
        panel.background = element_blank()
        )

ggplot()+
geom_boxplot(data = samp_thin, aes(y = pH))+
  labs(title = "pH thinned")+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        legend.position = 'bottom',
        panel.background = element_blank()
        )
```

##### Elevation plots
```{r elev_plot}
ggplot()+
geom_boxplot(data = samp, aes(y = elev))+
  labs(title = "Elev")+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        legend.position = 'bottom',
        panel.background = element_blank()
        )

ggplot()+
geom_boxplot(data = samp_thin, aes(y = elev))+
  labs(title = "Elev thinned")+
  theme(plot.title = element_text(size = rel(2), face = "bold"),
        plot.subtitle = element_text(size = rel(1.8)),
        legend.title = element_text(size = rel(1.8)),
        legend.text = element_text(size = rel(1.2)),
        legend.position = 'bottom',
        panel.background = element_blank()
        )
```

#### Colinearity {.tabset}

##### Pairwise plots - All observations

```{r pairwise_plots}
library(scatterPlotMatrix)
# Z<-cbind(samp$present, samp$temp, samp$precip, samp$calc, samp$pH, samp$elev)
# colnames(Z)<-c("Present", "Temp", "Precip", "Calcium", "pH", "Elevation")
# pairs(Z[,-1], lower.panel = panel.smooth2, upper.panel = panel.cor, diag.panel = panel.hist)

scatterPlotMatrix(samp, zAxisDim = "present", keptColumns = c("temp", "precip", "calc", "pH", "elev"),
                  corrPlotType = "Text")

```


##### Pairwise plots - Thinned

```{r pairwise_plots_thinned}
library(scatterPlotMatrix)
# Z<-cbind(samp$present, samp$temp, samp$precip, samp$calc, samp$pH, samp$elev)
# colnames(Z)<-c("Present", "Temp", "Precip", "Calcium", "pH", "Elevation")
# pairs(Z[,-1], lower.panel = panel.smooth2, upper.panel = panel.cor, diag.panel = panel.hist)

scatterPlotMatrix(samp_thin, zAxisDim = "present", keptColumns = c("temp", "precip", "calc", "pH", "elev"),
                  corrPlotType = "Text")

```



### Variance inflation factors {.active}
```{r corvif}
Z<-cbind(samp$present, samp$temp, samp$precip, samp$calc, samp$pH, samp$elev)
colnames(Z)<-c("Present", "Temp", "Precip", "Calcium", "pH", "Elevation")
corvif(Z[, c(-1,-7)])

Z_thin<-cbind(samp_thin$present, samp_thin$temp, samp_thin$precip, samp_thin$calc,
              samp_thin$pH, samp_thin$elev)
colnames(Z_thin)<-c("Present", "Temp", "Precip", "Calcium", "pH", "Elevation")
corvif(Z_thin[, c(-1,-7)])
```

In this, we are looking for variables with values above 3. Temperature, precipiation, pH and elevation are all above this threshold. This further confirms my suspicion that elevation needs to be removed for this model.

### Morans I
This is a measure of spatial autocorrelation. How related are the variables bsedon the locations based on where they are located. 

```{r morn}

library(geosphere)
#samp_dist<-as.matrix(distCosine(c(0,0), cbind(samp$x, samp$y)))
samp_dist <-distm(samp[1:2], fun = distHaversine)
samp_dist_inv<-1/samp_dist
diag(samp_dist_inv)<-0
samp_dist_inv[is.infinite(samp_dist_inv)]<-0


Moran.I(samp$temp, samp_dist_inv)


```


```{r moran_thin}
#samp_dist <- as.matrix(dist(cbind(samp_thin$x, samp_thin$y)))
samp_dist<-distm(samp_thin[1:2], fun = distHaversine)
samp_dist_inv<-1/samp_dist
diag(samp_dist_inv)<-0
samp_dist_inv[is.infinite(samp_dist_inv)]<-0


Moran.I(samp_thin$temp, samp_dist_inv)



```

